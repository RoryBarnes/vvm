#!/usr/bin/env bash
# vvm - Virtual VPLanet Machine
# Start an isolated Docker container with the complete VPLanet ecosystem.

set -euo pipefail

# ---------------------------------------------------------------------------
# fnResolveScriptDir: Follow symlinks to find the real script directory
# ---------------------------------------------------------------------------
fnResolveScriptDir() {
    local sSource="${BASH_SOURCE[0]}"
    while [ -L "${sSource}" ]; do
        local sDir
        sDir="$(cd "$(dirname "${sSource}")" && pwd -P)"
        sSource="$(readlink "${sSource}")"
        [[ "${sSource}" != /* ]] && sSource="${sDir}/${sSource}"
    done
    cd "$(dirname "${sSource}")" && pwd -P
}

# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------
VVM_DIR="$(fnResolveScriptDir)"
readonly VVM_DIR
readonly VVM_IMAGE="vvm:latest"
readonly VVM_CONTAINER="vvm"
readonly VVM_VOLUME="vvm-workspace"

# Detect platform and set appropriate values
if [[ "$(uname -s)" == "Darwin" ]]; then
    iTotalCores=$(sysctl -n hw.ncpu)
else
    iTotalCores=$(nproc)
fi
readonly iTotalCores
iContainerCores=$(( iTotalCores - 1 ))
readonly iContainerCores

# Temp files to clean up on exit
saCleanupFiles=()

fnCleanup() {
    if [ "${#saCleanupFiles[@]}" -gt 0 ]; then
        for sFile in "${saCleanupFiles[@]}"; do
            rm -f "${sFile}" 2>/dev/null
        done
    fi
}
trap fnCleanup EXIT

sDocker=""

# ---------------------------------------------------------------------------
# fnDisableX11Auth: Allow Docker containers to connect to the X11 display
# ---------------------------------------------------------------------------
fnDisableX11Auth() {
    local sXhost=""
    if command -v xhost > /dev/null 2>&1; then
        sXhost="xhost"
    elif [ -x "/opt/local/bin/xhost" ]; then
        sXhost="/opt/local/bin/xhost"
    elif [ -x "/opt/X11/bin/xhost" ]; then
        sXhost="/opt/X11/bin/xhost"
    fi
    if [ -n "${sXhost}" ]; then
        "${sXhost}" + > /dev/null 2>&1 || true
    fi
}

# ---------------------------------------------------------------------------
# fnPrintDockerError: Display a helpful error for Docker connectivity issues
# ---------------------------------------------------------------------------
fnPrintDockerError() {
    local sError="$1"

    if [[ "${sError}" == *"permission denied"* ]]; then
        echo "Error: Permission denied when connecting to Docker."
        echo "  Fix: sudo usermod -aG docker \$USER && newgrp docker"
    elif [[ "$(uname -s)" == "Darwin" ]]; then
        echo "Error: Docker daemon is not running."
        echo "  Fix: colima start --cpu ${iContainerCores} --memory 8"
    else
        echo "Error: Docker daemon is not running."
        echo "  Fix: sudo systemctl start docker"
    fi
}

# ---------------------------------------------------------------------------
# fnCheckDocker: Find the Docker binary and verify the daemon is reachable
# ---------------------------------------------------------------------------
fnCheckDocker() {
    if ! command -v docker > /dev/null 2>&1; then
        echo "Error: docker not found on PATH."
        exit 1
    fi
    sDocker="$(command -v docker)"

    local sError
    if sError=$("${sDocker}" info 2>&1); then
        return 0
    fi

    fnPrintDockerError "${sError}"
    exit 1
}

# ---------------------------------------------------------------------------
# fiGetFileEpoch: Return the modification time of a file as epoch seconds
# ---------------------------------------------------------------------------
fiGetFileEpoch() {
    local sFile="$1"
    if [[ "$(uname -s)" == "Darwin" ]]; then
        stat -f "%m" "${sFile}"
    else
        stat -c "%Y" "${sFile}"
    fi
}

# ---------------------------------------------------------------------------
# fbImageIsStale: Return true if source files are newer than the image
# ---------------------------------------------------------------------------
fbImageIsStale() {
    if ! "${sDocker}" image inspect "${VVM_IMAGE}" > /dev/null 2>&1; then
        return 0
    fi

    local sImageCreated
    sImageCreated=$("${sDocker}" image inspect "${VVM_IMAGE}" \
        --format '{{.Created}}' 2>/dev/null)

    local iImageEpoch
    if [[ "$(uname -s)" == "Darwin" ]]; then
        iImageEpoch=$(date -j -f "%Y-%m-%dT%H:%M:%S" \
            "${sImageCreated%%.*}" "+%s" 2>/dev/null || echo "0")
    else
        iImageEpoch=$(date -d "${sImageCreated}" "+%s" 2>/dev/null || echo "0")
    fi

    for sFile in "${VVM_DIR}/Dockerfile" "${VVM_DIR}/entrypoint.sh" "${VVM_DIR}/repos.conf"; do
        if [ -f "${sFile}" ] && [ "$(fiGetFileEpoch "${sFile}")" -gt "${iImageEpoch}" ]; then
            return 0
        fi
    done

    return 1
}

# ---------------------------------------------------------------------------
# fnBuildImage: Build the Docker image if source files have changed
# ---------------------------------------------------------------------------
fnBuildImage() {
    if fbImageIsStale; then
        echo "[vvm] Building container image..."
        "${sDocker}" build -t "${VVM_IMAGE}" "${VVM_DIR}"
        fnBuildClaudeOverlay
        echo "[vvm] Image built."
    fi
}

# ---------------------------------------------------------------------------
# fnBuildClaudeOverlay: Layer Claude Code on top of the base image
# ---------------------------------------------------------------------------
fnBuildClaudeOverlay() {
    if [ -f "${VVM_DIR}/.claude_enabled" ] && [ -f "${VVM_DIR}/Dockerfile.claude" ]; then
        echo "[vvm] Building Claude Code overlay..."
        "${sDocker}" build -t "${VVM_IMAGE}" -f "${VVM_DIR}/Dockerfile.claude" "${VVM_DIR}"
    fi
}

# ---------------------------------------------------------------------------
# fnCreateVolume: Ensure the named volume exists
# ---------------------------------------------------------------------------
fnCreateVolume() {
    if ! "${sDocker}" volume inspect "${VVM_VOLUME}" > /dev/null 2>&1; then
        echo "[vvm] Creating persistent workspace volume..."
        "${sDocker}" volume create "${VVM_VOLUME}"
    fi
}

# ---------------------------------------------------------------------------
# fnMountGitHubToken: Inject the gh CLI token into the container arguments
# ---------------------------------------------------------------------------
fnMountGitHubToken() {
    local sToken=""
    if command -v gh > /dev/null 2>&1; then
        sToken=$(gh auth token 2>/dev/null || true)
    fi
    if [ -n "${sToken}" ]; then
        local sTokenFile
        sTokenFile=$(mktemp "${HOME}/.vvm_auth_XXXXXX")
        echo "${sToken}" > "${sTokenFile}"
        chmod 600 "${sTokenFile}"
        saCleanupFiles+=("${sTokenFile}")
        saRunArgs+=(-v "${sTokenFile}:/run/secrets/gh_token:ro")
    else
        echo "[vvm] WARNING: GitHub CLI not authenticated."
        echo "[vvm]   Private repos will fail to clone."
        echo "[vvm]   Run: gh auth login"
    fi
}

# ---------------------------------------------------------------------------
# fnConfigureMacX11: Start XQuartz and configure display on macOS
# ---------------------------------------------------------------------------
fnConfigureMacX11() {
    if ! command -v xquartz > /dev/null 2>&1 && [ ! -d "/opt/X11" ]; then
        return
    fi
    if ! pgrep -x Xquartz > /dev/null 2>&1 \
        && ! pgrep -x X11.bin > /dev/null 2>&1 \
        && ! pgrep -x X11 > /dev/null 2>&1; then
        echo "[vvm] Starting XQuartz..."
        open -ga XQuartz
        sleep 2
    fi
    fnDisableX11Auth
    saRunArgs+=(-e "DISPLAY=host.docker.internal:0")
}

# ---------------------------------------------------------------------------
# fnConfigureLinuxX11: Grant container access to the host X11 display
# ---------------------------------------------------------------------------
fnConfigureLinuxX11() {
    if [[ "${DISPLAY:-}" != *:* ]]; then
        return
    fi
    if command -v xhost > /dev/null 2>&1; then
        xhost +local:docker > /dev/null 2>&1 || true
    fi
    saRunArgs+=(-e "DISPLAY=${DISPLAY}")
    saRunArgs+=(-v "/tmp/.X11-unix:/tmp/.X11-unix")
}

# ---------------------------------------------------------------------------
# fnStartContainer: Run the container with appropriate mounts
# ---------------------------------------------------------------------------
fnStartContainer() {
    saRunArgs=(
        --rm
        -it
        --name "${VVM_CONTAINER}"
        --hostname vvm
        --cpus "${iContainerCores}"
        -v "${VVM_VOLUME}:/workspace"
    )

    fnMountGitHubToken

    if [[ "$(uname -s)" == "Darwin" ]]; then
        fnConfigureMacX11
    else
        fnConfigureLinuxX11
    fi

    "${sDocker}" run "${saRunArgs[@]}" "${VVM_IMAGE}" "$@"
}

# ---------------------------------------------------------------------------
# fnShowStatus: Display current state of vvm resources
# ---------------------------------------------------------------------------
fnShowStatus() {
    echo "[vvm] Status:"
    echo ""

    if ! "${sDocker}" info > /dev/null 2>&1; then
        echo "  Docker daemon: NOT RUNNING"
        return
    fi
    echo "  Docker daemon: running"

    fnShowImageStatus
    fnShowVolumeStatus
    fnShowContainerStatus
}

# ---------------------------------------------------------------------------
# fnShowImageStatus: Print the image state
# ---------------------------------------------------------------------------
fnShowImageStatus() {
    if "${sDocker}" image inspect "${VVM_IMAGE}" > /dev/null 2>&1; then
        local sCreated
        sCreated=$("${sDocker}" image inspect "${VVM_IMAGE}" \
            --format '{{.Created}}' 2>/dev/null)
        echo "  Image: ${VVM_IMAGE} (built: ${sCreated})"
    else
        echo "  Image: not built"
    fi
}

# ---------------------------------------------------------------------------
# fnShowVolumeStatus: Print the volume state
# ---------------------------------------------------------------------------
fnShowVolumeStatus() {
    if "${sDocker}" volume inspect "${VVM_VOLUME}" > /dev/null 2>&1; then
        echo "  Volume: ${VVM_VOLUME} exists"
    else
        echo "  Volume: not created"
    fi
}

# ---------------------------------------------------------------------------
# fnShowContainerStatus: Print the container state
# ---------------------------------------------------------------------------
fnShowContainerStatus() {
    if "${sDocker}" container inspect "${VVM_CONTAINER}" > /dev/null 2>&1; then
        echo "  Container: running"
    else
        echo "  Container: not running"
    fi
}

# ---------------------------------------------------------------------------
# fnDestroyVolume: Remove workspace volume after confirmation
# ---------------------------------------------------------------------------
fnDestroyVolume() {
    echo "WARNING: This will delete all cloned repositories in the vvm workspace."
    echo -n "Are you sure? [y/N] "
    read -r sAnswer
    if [[ "${sAnswer}" =~ ^[Yy]$ ]]; then
        "${sDocker}" volume rm "${VVM_VOLUME}" 2>/dev/null || true
        echo "[vvm] Volume removed."
    else
        echo "[vvm] Cancelled."
    fi
}

# ---------------------------------------------------------------------------
# fnPrintUsage: Display help text
# ---------------------------------------------------------------------------
fnPrintUsage() {
    echo "Usage: vvm [options] [command]"
    echo ""
    echo "Start the Virtual VPLanet Machine container."
    echo ""
    echo "Options:"
    echo "  --build     Force rebuild the container image"
    echo "  --shell     Start an interactive shell (default)"
    echo "  --status    Show container and volume status"
    echo "  --destroy   Remove the workspace volume"
    echo "  --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  vvm                 Start interactive session"
    echo "  vvm --build         Force rebuild then start"
    echo "  vvm pytest          Run pytest inside the container"
    echo "  vvm --status        Check if container and volume exist"
}

# ===========================================================================
# Main
# ===========================================================================

case "${1:-}" in
    --help|-h)
        fnPrintUsage
        exit 0
        ;;
    --status)
        fnCheckDocker
        fnShowStatus
        exit 0
        ;;
    --destroy)
        fnCheckDocker
        fnDestroyVolume
        exit 0
        ;;
    --build)
        shift
        fnCheckDocker
        echo "[vvm] Forcing image rebuild..."
        "${sDocker}" build --no-cache -t "${VVM_IMAGE}" "${VVM_DIR}"
        fnBuildClaudeOverlay
        fnCreateVolume
        fnStartContainer "$@"
        ;;
    *)
        fnCheckDocker
        fnBuildImage
        fnCreateVolume
        fnStartContainer "$@"
        ;;
esac
