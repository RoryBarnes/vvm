#!/usr/bin/env bash
# vvm - Virtual VPLanet Machine
# Start an isolated Docker container with the complete VPLanet ecosystem.

set -euo pipefail

# ---------------------------------------------------------------------------
# fnResolveScriptDir: Follow symlinks to find the real script directory
# ---------------------------------------------------------------------------
fnResolveScriptDir() {
    local sSource="${BASH_SOURCE[0]}"
    while [ -L "${sSource}" ]; do
        local sDir
        sDir="$(cd "$(dirname "${sSource}")" && pwd -P)"
        sSource="$(readlink "${sSource}")"
        [[ "${sSource}" != /* ]] && sSource="${sDir}/${sSource}"
    done
    cd "$(dirname "${sSource}")" && pwd -P
}

# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------
VVM_DIR="$(fnResolveScriptDir)"
readonly VVM_DIR
readonly VVM_IMAGE="vvm:latest"
readonly VVM_CONTAINER="vvm"
readonly VVM_VOLUME="vvm-workspace"

# Detect platform and set appropriate values
if [[ "$(uname -s)" == "Darwin" ]]; then
    TOTAL_CORES=$(sysctl -n hw.ncpu)
else
    TOTAL_CORES=$(nproc)
fi
readonly TOTAL_CORES
CONTAINER_CORES=$(( TOTAL_CORES - 1 ))
readonly CONTAINER_CORES

# Temp files to clean up on exit
CLEANUP_FILES=()

fnCleanup() {
    if [ "${#CLEANUP_FILES[@]}" -gt 0 ]; then
        for sFile in "${CLEANUP_FILES[@]}"; do
            rm -f "${sFile}" 2>/dev/null
        done
    fi
}
trap fnCleanup EXIT

DOCKER=""

# ---------------------------------------------------------------------------
# fnDisableX11Auth: Allow Docker containers to connect to the X11 display
# ---------------------------------------------------------------------------
fnDisableX11Auth() {
    local sXhost=""
    if command -v xhost > /dev/null 2>&1; then
        sXhost="xhost"
    elif [ -x "/opt/local/bin/xhost" ]; then
        sXhost="/opt/local/bin/xhost"
    elif [ -x "/opt/X11/bin/xhost" ]; then
        sXhost="/opt/X11/bin/xhost"
    fi
    if [ -n "${sXhost}" ]; then
        "${sXhost}" + > /dev/null 2>&1 || true
    fi
}

# ---------------------------------------------------------------------------
# fnCheckDocker: Find the Docker binary and verify the daemon is reachable
# ---------------------------------------------------------------------------
fnCheckDocker() {
    if ! command -v docker > /dev/null 2>&1; then
        echo "Error: docker not found on PATH."
        exit 1
    fi
    DOCKER="$(command -v docker)"

    local sError
    if sError=$("${DOCKER}" info 2>&1); then
        return 0
    fi

    if [[ "${sError}" == *"permission denied"* ]]; then
        echo "Error: Permission denied when connecting to Docker."
        echo "  Fix: sudo usermod -aG docker \$USER && newgrp docker"
    elif [[ "$(uname -s)" == "Darwin" ]]; then
        echo "Error: Docker daemon is not running."
        echo "  Fix: colima start --cpu ${CONTAINER_CORES} --memory 8"
    else
        echo "Error: Docker daemon is not running."
        echo "  Fix: sudo systemctl start docker"
    fi
    exit 1
}

# ---------------------------------------------------------------------------
# fnBuildImage: Build the Docker image if source files have changed
# ---------------------------------------------------------------------------
fnBuildImage() {
    local bNeedsBuild=false

    if ! "${DOCKER}" image inspect "${VVM_IMAGE}" > /dev/null 2>&1; then
        bNeedsBuild=true
    fi

    if [ "${bNeedsBuild}" = false ]; then
        local sImageCreated
        sImageCreated=$("${DOCKER}" image inspect "${VVM_IMAGE}" \
            --format '{{.Created}}' 2>/dev/null)

        local iImageEpoch
        if [[ "$(uname -s)" == "Darwin" ]]; then
            iImageEpoch=$(date -j -f "%Y-%m-%dT%H:%M:%S" \
                "${sImageCreated%%.*}" "+%s" 2>/dev/null || echo "0")
        else
            iImageEpoch=$(date -d "${sImageCreated}" "+%s" 2>/dev/null || echo "0")
        fi

        for sFile in "${VVM_DIR}/Dockerfile" "${VVM_DIR}/entrypoint.sh" "${VVM_DIR}/repos.conf"; do
            if [ -f "${sFile}" ]; then
                local iFileEpoch
                if [[ "$(uname -s)" == "Darwin" ]]; then
                    iFileEpoch=$(stat -f "%m" "${sFile}")
                else
                    iFileEpoch=$(stat -c "%Y" "${sFile}")
                fi
                if [ "${iFileEpoch}" -gt "${iImageEpoch}" ]; then
                    bNeedsBuild=true
                    break
                fi
            fi
        done
    fi

    if [ "${bNeedsBuild}" = true ]; then
        echo "[vvm] Building container image..."
        "${DOCKER}" build -t "${VVM_IMAGE}" "${VVM_DIR}"
        fnBuildClaudeOverlay
        echo "[vvm] Image built."
    fi
}

# ---------------------------------------------------------------------------
# fnBuildClaudeOverlay: Layer Claude Code on top of the base image
# ---------------------------------------------------------------------------
fnBuildClaudeOverlay() {
    if [ -f "${VVM_DIR}/.claude_enabled" ] && [ -f "${VVM_DIR}/Dockerfile.claude" ]; then
        echo "[vvm] Building Claude Code overlay..."
        "${DOCKER}" build -t "${VVM_IMAGE}" -f "${VVM_DIR}/Dockerfile.claude" "${VVM_DIR}"
    fi
}

# ---------------------------------------------------------------------------
# fnCreateVolume: Ensure the named volume exists
# ---------------------------------------------------------------------------
fnCreateVolume() {
    if ! "${DOCKER}" volume inspect "${VVM_VOLUME}" > /dev/null 2>&1; then
        echo "[vvm] Creating persistent workspace volume..."
        "${DOCKER}" volume create "${VVM_VOLUME}"
    fi
}

# ---------------------------------------------------------------------------
# fnStartContainer: Run the container with appropriate mounts
# ---------------------------------------------------------------------------
fnStartContainer() {
    local daRunArgs=(
        --rm
        -it
        --name "${VVM_CONTAINER}"
        --hostname vvm
        --cpus "${CONTAINER_CORES}"
        -v "${VVM_VOLUME}:/workspace"
    )

    # GitHub authentication via gh CLI credential store
    local sToken=""
    if command -v gh > /dev/null 2>&1; then
        sToken=$(gh auth token 2>/dev/null || true)
    fi
    if [ -n "${sToken}" ]; then
        local sTokenFile
        sTokenFile=$(mktemp "${HOME}/.vvm_auth_XXXXXX")
        echo "${sToken}" > "${sTokenFile}"
        chmod 600 "${sTokenFile}"
        CLEANUP_FILES+=("${sTokenFile}")
        daRunArgs+=(-v "${sTokenFile}:/run/secrets/gh_token:ro")
    else
        echo "[vvm] WARNING: GitHub CLI not authenticated."
        echo "[vvm]   Private repos will fail to clone."
        echo "[vvm]   Run: gh auth login"
    fi

    # X11 forwarding for matplotlib plt.show()
    if [[ "$(uname -s)" == "Darwin" ]]; then
        if command -v xquartz > /dev/null 2>&1 || [ -d "/opt/X11" ]; then
            if ! pgrep -x Xquartz > /dev/null 2>&1 \
                && ! pgrep -x X11.bin > /dev/null 2>&1 \
                && ! pgrep -x X11 > /dev/null 2>&1; then
                echo "[vvm] Starting XQuartz..."
                open -ga XQuartz
                sleep 2
            fi
            fnDisableX11Auth
            daRunArgs+=(-e "DISPLAY=host.docker.internal:0")
        fi
    elif [ -n "${DISPLAY:-}" ]; then
        if command -v xhost > /dev/null 2>&1; then
            xhost +local:docker > /dev/null 2>&1 || true
        fi
        daRunArgs+=(-e "DISPLAY=${DISPLAY}")
        daRunArgs+=(-v "/tmp/.X11-unix:/tmp/.X11-unix")
    fi

    "${DOCKER}" run "${daRunArgs[@]}" "${VVM_IMAGE}" "$@"
}

# ---------------------------------------------------------------------------
# fnShowStatus: Display current state of vvm resources
# ---------------------------------------------------------------------------
fnShowStatus() {
    echo "[vvm] Status:"
    echo ""

    if "${DOCKER}" info > /dev/null 2>&1; then
        echo "  Docker daemon: running"
    else
        echo "  Docker daemon: NOT RUNNING"
        return
    fi

    if "${DOCKER}" image inspect "${VVM_IMAGE}" > /dev/null 2>&1; then
        local sCreated
        sCreated=$("${DOCKER}" image inspect "${VVM_IMAGE}" \
            --format '{{.Created}}' 2>/dev/null)
        echo "  Image: ${VVM_IMAGE} (built: ${sCreated})"
    else
        echo "  Image: not built"
    fi

    if "${DOCKER}" volume inspect "${VVM_VOLUME}" > /dev/null 2>&1; then
        echo "  Volume: ${VVM_VOLUME} exists"
    else
        echo "  Volume: not created"
    fi

    if "${DOCKER}" container inspect "${VVM_CONTAINER}" > /dev/null 2>&1; then
        echo "  Container: running"
    else
        echo "  Container: not running"
    fi
}

# ---------------------------------------------------------------------------
# fnDestroyVolume: Remove workspace volume after confirmation
# ---------------------------------------------------------------------------
fnDestroyVolume() {
    echo "WARNING: This will delete all cloned repositories in the vvm workspace."
    echo -n "Are you sure? [y/N] "
    read -r sAnswer
    if [[ "${sAnswer}" =~ ^[Yy]$ ]]; then
        "${DOCKER}" volume rm "${VVM_VOLUME}" 2>/dev/null || true
        echo "[vvm] Volume removed."
    else
        echo "[vvm] Cancelled."
    fi
}

# ---------------------------------------------------------------------------
# fnPrintUsage: Display help text
# ---------------------------------------------------------------------------
fnPrintUsage() {
    echo "Usage: vvm [options] [command]"
    echo ""
    echo "Start the Virtual VPLanet Machine container."
    echo ""
    echo "Options:"
    echo "  --build     Force rebuild the container image"
    echo "  --shell     Start an interactive shell (default)"
    echo "  --status    Show container and volume status"
    echo "  --destroy   Remove the workspace volume"
    echo "  --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  vvm                 Start interactive session"
    echo "  vvm --build         Force rebuild then start"
    echo "  vvm pytest          Run pytest inside the container"
    echo "  vvm --status        Check if container and volume exist"
}

# ===========================================================================
# Main
# ===========================================================================

case "${1:-}" in
    --help|-h)
        fnPrintUsage
        exit 0
        ;;
    --status)
        fnCheckDocker
        fnShowStatus
        exit 0
        ;;
    --destroy)
        fnCheckDocker
        fnDestroyVolume
        exit 0
        ;;
    --build)
        shift
        fnCheckDocker
        echo "[vvm] Forcing image rebuild..."
        "${DOCKER}" build --no-cache -t "${VVM_IMAGE}" "${VVM_DIR}"
        fnBuildClaudeOverlay
        fnCreateVolume
        fnStartContainer "$@"
        ;;
    *)
        fnCheckDocker
        fnBuildImage
        fnCreateVolume
        fnStartContainer "$@"
        ;;
esac
